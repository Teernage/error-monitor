<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Error Monitor SDK é¶åœº</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Helvetica, Arial, sans-serif;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      h1 {
        color: #333;
      }
      .btn-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      button {
        padding: 12px 20px;
        font-size: 14px;
        cursor: pointer;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
        transition: all 0.2s;
      }
      button:hover {
        background-color: #e0e0e0;
        transform: translateY(-1px);
      }
      button:active {
        transform: translateY(1px);
      }
      .danger {
        color: #d32f2f;
        border-color: #d32f2f;
        background-color: #ffebee;
      }
      .danger:hover {
        background-color: #ffcdd2;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ¯ Error Monitor SDK é¶åœº</h1>
    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è§¦å‘é”™è¯¯ï¼Œè§‚å¯Ÿ<b>ç»ˆç«¯æ§åˆ¶å°</b>çš„æŠ¥é”™è¾“å‡ºã€‚</p>

    <div class="btn-group">
      <button class="danger" id="btn-js">ğŸ’¥ è§¦å‘ JS è¿è¡Œæ—¶é”™è¯¯</button>
      <button class="danger" id="btn-promise">ğŸ’¥ è§¦å‘ Promise Reject</button>
      <button class="danger" id="btn-xhr">ğŸ’¥ è§¦å‘ XHR è¯·æ±‚å¤±è´¥</button>
      <button class="danger" id="btn-fetch">ğŸ’¥ è§¦å‘ Fetch è¯·æ±‚å¤±è´¥</button>
      <button class="danger" id="btn-resource">
        ğŸ’¥ è§¦å‘ èµ„æºåŠ è½½å¤±è´¥ (404)
      </button>
      <button class="danger" id="btn-vue">ğŸ’¥ è§¦å‘ Vue ç»„ä»¶é”™è¯¯</button>
      <button class="danger" id="btn-react">ğŸ’¥ è§¦å‘ React ç»„ä»¶é”™è¯¯</button>
    </div>

    <div
      id="vue-app"
      style="
        margin-top: 20px;
        border: 1px dashed #42b983;
        padding: 10px;
        display: none;
      "
    >
      <h3>Vue 3 æµ‹è¯•åŒºåŸŸ</h3>
      <p>{{ message }}</p>
      <button @click="triggerError">åœ¨ Vue ä¸­è§¦å‘é”™è¯¯</button>
    </div>

    <div
      id="react-app"
      style="
        margin-top: 20px;
        border: 1px dashed #61dafb;
        padding: 10px;
        display: none;
      "
    ></div>

    <!-- å¼•å…¥ SDK (æœ¬åœ°æ‰“åŒ…ç‰ˆæœ¬) -->
    <script src="../dist/index.umd.js"></script>
    
    <!-- å¼•å…¥æ¡†æ¶ä¾èµ– (ä½¿ç”¨å›½å†…é•œåƒåŠ é€Ÿ) -->
    <!-- Vue 3 -->
    <script src="https://npm.elemecdn.com/vue@3/dist/vue.global.js"></script>
    <!-- React 18 & ReactDOM 18 -->
    <script crossorigin src="https://npm.elemecdn.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://npm.elemecdn.com/react-dom@18/umd/react-dom.development.js"></script>

    <script>
      /**
       * =========================================================================
       *  SDK åˆå§‹åŒ–é…ç½®
       * =========================================================================
       * åœ¨ UMD æ¨¡å¼ä¸‹ï¼ŒSDK ä¼šæŒ‚è½½åˆ°å…¨å±€å˜é‡ window.ErrorMonitor
       * (è¯¥å˜é‡ååœ¨ rollup.config.js çš„ output.name ä¸­é…ç½®)
       */
      console.log('æ­£åœ¨åˆå§‹åŒ– SDK (CDN æ¨¡å¼)...', ErrorMonitor);

      // æ‰‹åŠ¨åˆå§‹åŒ–å…¨å±€ç›‘æ§ (æ•è· JS/ç½‘ç»œ/èµ„æºé”™è¯¯)
      // æ³¨æ„ï¼šå¦‚æœæ˜¯ Vue/React åœºæ™¯ï¼Œé€šå¸¸ç”±æ’ä»¶æˆ–è¾…åŠ©å‡½æ•°è‡ªåŠ¨è°ƒç”¨ï¼Œ
      // è¿™é‡Œæ˜¾å¼è°ƒç”¨æ˜¯ä¸ºäº†æ¼”ç¤ºåŸºç¡€åŠŸèƒ½çš„ç‹¬ç«‹ä½¿ç”¨ã€‚
      ErrorMonitor.initErrorMonitor({
        reportUrl: 'http://localhost:3000/error-report',
        projectName: 'Test-Playground-Global',
        environment: 'dev',
      });

      /**
       * =========================================================================
       *  åŸºç¡€é”™è¯¯æµ‹è¯•ç”¨ä¾‹
       * =========================================================================
       */

      // 1. JS è¿è¡Œæ—¶é”™è¯¯ (ReferenceError)
      // é¢„æœŸï¼šæ•è·åˆ° 'JavaScript Error'ï¼ŒåŒ…å«å †æ ˆä¿¡æ¯
      document.getElementById('btn-js').onclick = () => {
        const obj = {};
        console.log(obj.notExist.func()); // å…¸å‹ç©ºæŒ‡é’ˆé”™è¯¯
      };

      // 2. Promise æœªæ•è·å¼‚å¸¸ (Unhandled Rejection)
      // é¢„æœŸï¼šæ•è·åˆ° 'Unhandled Promise Rejection'
      document.getElementById('btn-promise').onclick = () => {
        Promise.reject(new Error('è¿™æ˜¯ä¸€ä¸ªæœªæ•è·çš„ Promise é”™è¯¯ï¼'));
      };

      // 3. XHR è¯·æ±‚é”™è¯¯ (Network Error)
      // é¢„æœŸï¼šæ•è·åˆ° 'Network Error'ï¼Œè®°å½•è¯·æ±‚æ–¹æ³•å’Œ URL
      document.getElementById('btn-xhr').onclick = () => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:9999/not-exist'); // ç«¯å£ä¸å­˜åœ¨å¯¼è‡´è¿æ¥å¤±è´¥
        xhr.send();
      };

      // 4. Fetch è¯·æ±‚é”™è¯¯ (Fetch Error)
      // é¢„æœŸï¼šæ•è·åˆ° 'Fetch Error'
      document.getElementById('btn-fetch').onclick = () => {
        fetch('http://localhost:9999/not-exist'); // ç«¯å£ä¸å­˜åœ¨
      };

      // 5. èµ„æºåŠ è½½é”™è¯¯ (Resource Load Error)
      // é¢„æœŸï¼šæ•è·åˆ° 'Resource Load Error'ï¼Œä¸”ä¸å†’æ³¡åˆ° window.onerror
      document.getElementById('btn-resource').onclick = () => {
        const img = document.createElement('img');
        img.src = '/404-image.png'; // å›¾ç‰‡èµ„æºä¸å­˜åœ¨
        document.body.appendChild(img);
        // ç¨åç§»é™¤ DOM å…ƒç´ ä»¥å…å½±å“é¡µé¢ç¾è§‚
        setTimeout(() => document.body.removeChild(img), 100);
      };

      /**
       * =========================================================================
       *  æ¡†æ¶é›†æˆæµ‹è¯•ç”¨ä¾‹ (Vue / React)
       * =========================================================================
       */

      // 6. Vue 3 ç»„ä»¶é”™è¯¯æµ‹è¯•
      // åŸç†ï¼šé€šè¿‡ app.config.errorHandler å…¨å±€æ•è·
      document.getElementById('btn-vue').onclick = () => {
        const vueContainer = document.getElementById('vue-app');
        vueContainer.style.display = 'block';
        
        // é¿å…é‡å¤åˆ›å»º Vue å®ä¾‹
        if (vueContainer.__vue_app__) return; 

        const app = Vue.createApp({
          data() {
            return { message: 'Hello Vue 3!' };
          },
          methods: {
            triggerError() {
              throw new Error('è¿™æ˜¯ Vue ç»„ä»¶å†…éƒ¨è§¦å‘çš„é”™è¯¯ï¼');
            },
          },
        });

        // æ ¸å¿ƒï¼šå®‰è£…ç›‘æ§æ’ä»¶ (ä¸€è¡Œä»£ç æ¥å…¥)
        app.use(ErrorMonitor.VueErrorMonitorPlugin, {
          reportUrl: 'http://localhost:3000/error-report',
          projectName: 'Test-Playground-Vue',
          environment: 'dev',
        });

        app.mount('#vue-app');
        vueContainer.__vue_app__ = app;
      };

      // 7. React 18 ç»„ä»¶é”™è¯¯æµ‹è¯•
      // åŸç†ï¼šé€šè¿‡ Error Boundary åŒ…è£¹ç»„ä»¶æ ‘æ•è·
      document.getElementById('btn-react').onclick = () => {
        const reactContainer = document.getElementById('react-app');
        reactContainer.style.display = 'block';

        // é¿å…é‡å¤æŒ‚è½½
        if (reactContainer._isMounted) return;

        // --- å®šä¹‰ä¸€ä¸ªä¼šå´©æºƒçš„å­ç»„ä»¶ ---
        const BuggyComponent = () => {
          const [hasError, setHasError] = React.useState(false);
          if (hasError) {
            throw new Error('è¿™æ˜¯ React ç»„ä»¶å†…éƒ¨è§¦å‘çš„é”™è¯¯ï¼');
          }
          return React.createElement(
            'button',
            { onClick: () => setHasError(true) },
            'åœ¨ React ä¸­è§¦å‘é”™è¯¯'
          );
        };

        // --- å®šä¹‰æ ¹ç»„ä»¶ ---
        const App = () => {
          return React.createElement(
            'div',
            null,
            React.createElement('h3', null, 'React æµ‹è¯•åŒºåŸŸ'),
            React.createElement(BuggyComponent)
          );
        };

        // æ ¸å¿ƒï¼šåˆ›å»ºç›‘æ§ä¸“ç”¨çš„ Error Boundary (è‡ªåŠ¨åˆå§‹åŒ–å…¨å±€ç›‘æ§)
        const ErrorBoundary = ErrorMonitor.createReactErrorBoundary(React, {
          reportUrl: 'http://localhost:3000/error-report',
          projectName: 'Test-Playground-React',
          environment: 'dev',
        });

        // æ¸²æŸ“ï¼šç”¨ ErrorBoundary åŒ…è£¹æ•´ä¸ª App
        const root = ReactDOM.createRoot(reactContainer);
        root.render(
          React.createElement(
            ErrorBoundary,
            { fallback: React.createElement('h3', { style: { color: 'red' } }, 'React ç»„ä»¶å´©æºƒäº†ï¼å·²æ•è·ã€‚') },
            React.createElement(App)
          )
        );
        reactContainer._isMounted = true;
      };
    </script>
  </body>
</html>
